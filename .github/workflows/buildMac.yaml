name: buildMacOS

on:
  workflow_dispatch  # manuell starten

jobs:
  build_and_test_macos:
    name: "Build and test (macOS)"
    runs-on: macos-latest
    steps:
    - name: Install Ninja
      run: brew install ninja

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'

    - uses: actions/checkout@v3

    - name: Build
      run: |
        cmake -S . -B build -G "Ninja Multi-Config"
        cmake --build build --config Release

    - name: Prepare deploy directory
      run: |
        mkdir -p deploy
        cp -R build/Release/appballHunt.app deploy/
        echo "Deploy directory contents:"
        ls -R deploy

    - name: Deploy Qt (macOS)
      run: |
        cd deploy
        echo "Running macdeployqt6..."
        macdeployqt6 appballHunt.app \
          -qmldir=${{ github.workspace }} \
          -always-overwrite \
          -verbose=2
        # Entferne Quarantine-Attribute, damit App im CI l√§uft
        xattr -cr appballHunt.app
        # Entferne Debug-Symbole manuell
        echo "Stripping symbols..."
        strip appballHunt.app/Contents/MacOS/appballHunt || true
        echo "Deployment finished:"
        du -sh appballHunt.app

    - name: Test if executable works
      shell: bash
      run: |
        cd deploy
        echo "=== Running appballHunt.app ==="
        ./appballHunt.app/Contents/MacOS/appballHunt || echo "App exited with code $?"

    - name: Verify logfile output
      shell: bash
      run: |
        cd deploy
        echo "=== Checking startupLog.txt ==="
        if [ -f startupLog.txt ]; then
          echo "startupLog.txt found"
          if grep -q "run qt eventLoop" startupLog.txt; then
            echo "Log contains 'run qt eventLoop'"
          else
            echo "Log file found but message missing"
            echo "----- Log content -----"
            cat startupLog.txt
            exit 1
          fi
        else
          echo "startupLog.txt not found!"
          ls -la
          exit 1
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qt-app-macos
        path: deploy/
